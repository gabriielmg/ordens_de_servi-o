<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Ordens de Servi√ßo - Facilities</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #0d47a1;
            --accent-color: #1976d2;
            --success-color: #4caf50;
            --danger-color: #ef5350;
            --bg-color: #e3f2fd;
            --card-bg: #ffffff;
            --text-primary: #0d1b2a;
            --text-secondary: #44546b;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --border-radius: 14px;
            --transition: all 0.3s ease;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background: var(--bg-color);
            margin: 0;
            padding: 0;
            color: var(--text-primary);
            min-height: 100vh;
        }

        header {
            background: var(--primary-color);
            color: white;
            padding: 1rem;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 10;
            border-bottom-left-radius: var(--border-radius);
            border-bottom-right-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        header h1 {
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.6rem;
        }

        header::before {
            content: "üìã";
            font-size: 1.8rem;
        }

        main {
            max-width: 1200px;
            margin: 1rem auto;
            padding: 1rem;
        }

        /* Grid / Select de Capelas */
        .capelas-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .capela-btn {
            background: var(--card-bg);
            border: 2px solid #bbdefb;
            border-radius: var(--border-radius);
            padding: 1.25rem 1rem;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            box-shadow: var(--shadow);
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: var(--transition);
        }

        .capela-btn:hover,
        .capela-btn:focus {
            background: var(--accent-color);
            color: white;
            transform: translateY(-2px);
        }

        /* Estilo do select de capelas */
        .capelas-select {
            width: 100%;
            padding: 0.75rem 1rem;
            border-radius: var(--border-radius);
            border: 2px solid #bbdefb;
            background: var(--card-bg);
            font-size: 1rem;
            box-shadow: var(--shadow);
            cursor: pointer;
            transition: var(--transition);
        }

        .capelas-select:focus {
            outline: none;
            border-color: var(--accent-color);
            transform: translateY(-2px);
        }

        /* Bot√£o Recarregar */
        .reload-section {
            text-align: center;
            margin-bottom: 1rem;
        }

        .reload-btn {
            background: var(--success-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            padding: 0.75rem 2rem;
            cursor: pointer;
            box-shadow: var(--shadow);
            transition: var(--transition);
            width: 100%;
            max-width: 250px;
        }

        .reload-btn:hover,
        .reload-btn:focus {
            background: #388e3c;
        }

        /* Filtro por Data */
        .filter-section {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.75rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }

        .filter-section .date-group {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            width: 150px;
        }

        .filter-section input[type="date"] {
            padding: 0.5rem;
            border-radius: var(--border-radius);
            border: 1px solid #90caf9;
        }

        .filter-btn {
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .filter-btn:disabled {
            background: #90a4ae;
            cursor: not-allowed;
        }

        /* Lista de OS */
        .os-section {
            display: none;
            animation: fadeIn 0.4s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .os-section h2 {
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

        .os-list {
            list-style: none;
            padding: 0;
            display: grid;
            gap: 1rem;
        }

        .os-item {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 1rem;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            border-left: 4px solid var(--accent-color);
        }

        .os-item strong {
            color: var(--primary-color);
        }

        .os-item .data-badge {
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 20px;
            font-size: 0.85rem;
            width: fit-content;
        }

        .os-item .data-badge.overdue {
            background: var(--danger-color); /* data anterior a hoje */
        }

        .os-item .data-badge.today {
            background: #ff9800; /* hoje */
        }

        .os-item .data-badge.this-week {
            background: #fdd835; /* dentro dos pr√≥ximos 7 dias */
            color: #000;
        }

        .os-item .data-badge.future {
            background: var(--success-color); /* depois de 7 dias */
        }

        .os-item .descricao {
            font-style: italic;
            color: var(--text-secondary);
        }

        /* Mensagem de Erro */
        .error {
            background: #ffebee;
            color: var(--danger-color);
            padding: 1rem;
            border-radius: var(--border-radius);
            text-align: center;
            box-shadow: var(--shadow);
            max-width: 500px;
            margin: 1rem auto;
        }

        /* Responsividade */
        @media(max-width:768px) {
            .capelas-grid {
                grid-template-columns: 1fr;
            }

            .filter-section .date-group {
                width: 100%;
            }

            .reload-btn {
                max-width: 100%;
            }
        }
    </style>
</head>

<body>
    <header>
        <h1>Sistema de Ordens de Servi√ßo</h1>
    </header>

    <main>
        <div class="capelas-grid" id="propriedades"></div>

        <div class="reload-section">
            <button class="reload-btn" onclick="carregarDados()">üîÑ Recarregar Dados</button>
        </div>

        <div class="filter-section">
            <div class="date-group">
                <label for="dataInicio">Data Inicial:</label>
                <input type="date" id="dataInicio" onchange="atualizarBotaoFiltrar()">
            </div>
            <div class="date-group">
                <label for="dataFim">Data Final:</label>
                <input type="date" id="dataFim" onchange="atualizarBotaoFiltrar()">
            </div>
            <button class="filter-btn" id="btnFiltrar" onclick="filtrarPorIntervalo()" disabled>üìÖ Filtrar</button>
        </div>

        <div class="os-section" id="listaOS"></div>
    </main>

    <script>
        // --- IN√çCIO: API para data real ---
        let dataHojeReal = null;

        async function obterDataReal() {
            try {
                const res = await fetch("https://worldtimeapi.org/api/ip");
                const data = await res.json();
                dataHojeReal = new Date(data.datetime);
                console.log("Data real obtida:", dataHojeReal.toLocaleString());
            } catch (err) {
                console.warn("Erro ao obter hora real, usando hora local:", err);
                dataHojeReal = new Date(); // fallback local
            }
        }
        // --- FIM: API para data real ---

        let allOS = [];
        let capelas = {};

        const spreadsheetId = "1vp45PmYUejX_zQpMWgOMC5AejB7h_wKe4DVPRVrymRU";
        const apiKey = "AIzaSyBR-kigig741xsyRnllvtKbsxEGBQml0PE";
        const range = "Sheet1!A:E";
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${range}?key=${apiKey}`;

        // Fun√ß√µes de data
        function parseDataBrasileira(str) {
            if (!str) return null;
            const p = str.split('/');
            if (p.length !== 3) return null;
            const d = parseInt(p[0]), m = parseInt(p[1]) - 1, y = parseInt(p[2]);
            const dt = new Date(y, m, d);
            if (isNaN(dt.getTime())) return null;
            return dt;
        }

        function formatarData(d) {
            if (!d) return 'Data inv√°lida';
            return `${String(d.getDate()).padStart(2, '0')}/${String(d.getMonth() + 1).padStart(2, '0')}/${d.getFullYear()}`;
        }

        // Normaliza para comparar s√≥ a data (sem horas)
        function getDateOnly(d) {
            const x = new Date(d);
            x.setHours(0, 0, 0, 0);
            return x;
        }

        // Retorna classe para badge com base na diferen√ßa em dias usando dataHojeReal (obtida pela API)
        function getBadgeClassForDate(dt) {
            const hoje = dataHojeReal ? getDateOnly(dataHojeReal) : getDateOnly(new Date());
            const alvo = getDateOnly(dt);
            const diff = Math.round((alvo - hoje) / (1000 * 60 * 60 * 24));
            if (diff < 0) return 'overdue';      // j√° venceu
            if (diff === 0) return 'today';      // vence hoje
            if (diff > 0 && diff <= 7) return 'this-week'; // dentro dos pr√≥ximos 7 dias
            return 'future';                     // depois de 7 dias
        }

        // Helper para renderizar listas de OS de forma consistente.
        function renderOSList(sorted, title, showCapelaInItem = true) {
            const div = document.getElementById('listaOS');
            if (!sorted || !sorted.length) {
                div.innerHTML = `<h2>${title}</h2><p style="text-align:center;color:#44546b;">Nenhuma OS encontrada.</p>`;
            } else {
                div.innerHTML = `<h2>${title}</h2>
                    <ul class="os-list">
                        ${sorted.map(os => {
                            const badgeClass = getBadgeClassForDate(os.dataObj);
                            return `<li class="os-item">
                                <strong>${showCapelaInItem ? (os.capela + ' - ') : ''}${os.numeroOS} ‚Äî ${os.assunto}</strong>
                                <span class="data-badge ${badgeClass}">${os.dataStr}</span>
                                <p class="descricao">${os.descricao}</p>
                            </li>`;
                        }).join('')}
                    </ul>`;
            }
            div.style.display = 'block';
            div.scrollIntoView({ behavior: 'smooth' });
        }

        // Carregar dados da planilha
        async function carregarDados() {
            try {
                const res = await fetch(url);
                const data = await res.json();
                const values = data.values || [];
                if (values.length < 2) throw new Error('Planilha vazia');

                allOS = [];
                capelas = {};

                values.slice(1).forEach(row => {
                    if (row.length < 5 || !row[0]) return;
                    const [capela, numeroOS, dataStrRaw, assunto, descricao] = row.map(r => r?.trim() || '');
                    const dataObj = parseDataBrasileira(dataStrRaw);
                    if (capela && dataObj) {
                        allOS.push({ capela, numeroOS, dataObj, dataStr: formatarData(dataObj), assunto, descricao });
                        if (!capelas[capela]) capelas[capela] = [];
                        capelas[capela].push({ capela, numeroOS, dataObj, dataStr: formatarData(dataObj), assunto, descricao });
                    }
                });

                // Criar select de capelas em vez de v√°rios bot√µes
                const divProps = document.getElementById('propriedades');
                divProps.innerHTML = '';
                const select = document.createElement('select');
                select.id = 'capelaSelect';
                select.className = 'capelas-select';

                const optAll = document.createElement('option');
                optAll.value = '__todas__';
                optAll.textContent = 'Todas as capelas';
                select.appendChild(optAll);

                Object.keys(capelas).sort().forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c;
                    opt.textContent = c;
                    select.appendChild(opt);
                });

                select.onchange = () => {
                    const val = select.value;
                    if (val === '__todas__') exibirTodasOS();
                    else exibirOSCapela(val);
                };

                divProps.appendChild(select);

                exibirTodasOS();

            } catch (err) {
                document.getElementById('listaOS').innerHTML = `<div class="error">${err.message}</div>`;
                console.error(err);
            }
        }

        function exibirTodasOS() {
            const div = document.getElementById('listaOS');
            if (!allOS.length) {
                div.innerHTML = '<h2>Todas as OSs</h2><p style="text-align:center;color:#44546b;">Nenhuma OS encontrada.</p>';
                div.style.display = 'block';
                return;
            }
            const sorted = allOS.slice().sort((a, b) => a.dataObj - b.dataObj);
            renderOSList(sorted, `Todas as OSs (${sorted.length})`, true); // mostrar capela dentro do item quando for "todas"
        }

        function exibirOSCapela(c) {
            const osCap = allOS.filter(os => os.capela.toLowerCase() === c.toLowerCase());
            if (!osCap.length) {
                const div = document.getElementById('listaOS');
                div.innerHTML = `<h2>OSs da Capela: ${c}</h2><p style="text-align:center;color:#44546b;">Nenhuma OS encontrada.</p>`;
                div.style.display = 'block';
                return;
            }
            const sorted = osCap.slice().sort((a, b) => a.dataObj - b.dataObj);
            // Ao visualizar por capela, n√£o repetir o nome da capela em cada card ‚Äî o t√≠tulo j√° mostra.
            renderOSList(sorted, `OSs da Capela: ${c} (${sorted.length})`, false);
        }

        function atualizarBotaoFiltrar() {
            const inicio = document.getElementById('dataInicio').value;
            const fim = document.getElementById('dataFim').value;
            document.getElementById('btnFiltrar').disabled = !(inicio && fim);
        }

        function filtrarPorIntervalo() {
            const inicioStr = document.getElementById('dataInicio').value;
            const fimStr = document.getElementById('dataFim').value;
            if (!inicioStr || !fimStr) return;

            const dataInicio = new Date(inicioStr);
            const dataFim = new Date(fimStr);

            const filtradas = allOS.filter(os => os.dataObj >= dataInicio && os.dataObj <= dataFim);

            // Decidir se deve mostrar o nome da capela dentro do item:
            // se houver um filtro de capela selecionado, j√° mostramos no t√≠tulo, ent√£o omitimos dentro do card.
            const capelaSelect = document.getElementById('capelaSelect');
            const selectedCapela = capelaSelect ? capelaSelect.value : '__todas__';
            const showCapelaInItem = (selectedCapela === '__todas__');

            if (!filtradas.length) {
                const div = document.getElementById('listaOS');
                div.innerHTML = `<h2>OSs entre ${formatarData(dataInicio)} e ${formatarData(dataFim)}</h2>
                    <p style="text-align:center;color:#44546b;">Nenhuma OS encontrada nesse intervalo.</p>`;
                div.style.display = 'block';
            } else {
                const sorted = filtradas.slice().sort((a, b) => a.dataObj - b.dataObj);
                renderOSList(sorted, `OSs entre ${formatarData(dataInicio)} e ${formatarData(dataFim)} (${sorted.length})`, showCapelaInItem);
            }
        }

        window.onload = async () => {
            await obterDataReal(); // primeiro busca a data real
            carregarDados();       // depois carrega o resto do sistema
        };
    </script>
</body>

</html>
